# bqrun

## 概要
ディレクトリの中にあるsqlファイルを全て読み、依存関係を解析し（あるファイルAで`select .. from`されているテーブルが別のファイルBで`create table`されていた場合、
BはAより前に実行される）、順番に実行するためのMakefileを作成、makeを実行する。

## 使い方
1. [alphadag](https://github.com/Matts966/alphasql)をインストールする
1. このレポジトリを適当な場所にcloneする
1. `make install`を実行（環境によっては`sudo`が必要）。あるいは`make install-develop`を実行する。
   `install-develop`を用いた場合、このディレクトリ内のファイルを変更すると、その変更が即座に有効になる。`install`の場合は、改めて`make install`しないと変更が反映されない。
1. sqlファイルのあるディレクトリで`bqrun`を実行すると、全てのクエリが順番に実行される

## 前提
1. 1つのディレクトリの中に全てのSQLファイルが入っていること
1. 全てのSQLファイルは拡張子`.sql`を持つこと（クエリ以外に`.sql`で終わるファイルがないこと）

## 大まかな動作
1. 全SQLファイルを読んで依存関係を解析、依存関係に従ったMakefileを作成する
1. このMakefileにより、各ファイルに対し以下のようなコマンドが実行される
    1. 各SQLファイルを`bq query`に投げる
    1. `done.<base name>` というファイルを作成する(`<base name>`は、ファイル名の拡張子以外)
1. 2回目以降の実行では、各ファイルについて`done.<base name>`ファイルのタイムスタンプと、依存先のファイルのタイムスタンプを比較し再実行が必要な部分だけが実行される

## その他
1. オプションとして`-p=<num>`または`--parallel=<num>`を受け付ける。これにより、並列実行数を指定できる（デフォルトは8)

